version: 2.1

commands:

  checkout_merge:
    description: "checkout merge branch"
    steps:
      - checkout
  #     - run:
  #         name: Checkout merge branch
  #         command: |
  #           set -ex
  #           BRANCH=$(git rev-parse --abbrev-ref HEAD)
  #           if [[ "$BRANCH" != "master" ]]; then
  #             git fetch --force origin ${CIRCLE_BRANCH}/merge:merged/${CIRCLE_BRANCH}
  #             git checkout "merged/$CIRCLE_BRANCH"
  #           fi

  install-conda:
    steps:
      - run:
          name: Installing Conda
          command: |
            wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh
            bash Miniconda3-latest-Linux-x86_64.sh -b -p $HOME/conda
            export PATH=$HOME/conda/bin:$PATH
            echo 'export PATH=$HOME/conda/bin:$PATH' >> $BASH_ENV
            conda install -y python=3

  install-pytorch:
    steps:
      - run:
          name: Installing PyTorch
          command: |
            conda install pytorch -yc pytorch-nightly
            conda install -y numpy scipy

  install-cuda:
    steps:
      - run:
          name: Installing CUDA
          command: |
            wget http://developer.download.nvidia.com/compute/cuda/10.2/Prod/local_installers/cuda-repo-ubuntu1604-10-2-local-10.2.89-440.33.01_1.0-1_amd64.deb
            sudo dpkg -i cuda-repo-ubuntu1604-10-2-local-10.2.89-440.33.01_1.0-1_amd64.deb
            sudo apt-key add /var/cuda-repo-10-2-local-10.2.89-440.33.01/7fa2af80.pub
            sudo apt-get update
            sudo apt-get -y install cuda

  build-csprng:
    steps:
      - run:
          name: Building CSPRNG
          command: python setup.py install

  run-tests:
    steps:
      - run:
          name: Running tests
          command: python test/test_csprng.py

binary_common: &binary_common
  parameters:
    # Edit these defaults to do a release`
    build_version:
      description: "version number of release binary; by default, build a nightly"
      type: string
      default: ""
    pytorch_version:
      description: "PyTorch version to build against; by default, use a nightly"
      type: string
      default: ""
    # Don't edit these
    python_version:
      description: "Python version to build against (e.g., 3.7)"
      type: string
    cu_version:
      description: "CUDA version to build against, in CU format (e.g., cpu or cu100)"
      type: string
    unicode_abi:
      description: "Python 2.7 wheel only: whether or not we are cp27mu (default: no)"
      type: string
      default: ""
    wheel_docker_image:
      description: "Wheel only: what docker image to use"
      type: string
      default: "pytorch/manylinux-cuda101"
  environment:
    PYTHON_VERSION: << parameters.python_version >>
    PYTORCH_VERSION: << parameters.pytorch_version >>
    UNICODE_ABI: << parameters.unicode_abi >>
    CU_VERSION: << parameters.cu_version >>

jobs:

  build-nvcc:
    machine:
      image: ubuntu-1604:201903-01
    resource_class: gpu.small
    steps:
      - checkout
      - install-conda
      - install-pytorch
      - install-cuda
      - build-csprng
      - run-tests

  build-cc:
    machine:
      image: ubuntu-1604:201903-01
    resource_class: large
    steps:
      - checkout
      - install-conda
      - install-pytorch
      - build-csprng
      - run-tests

  build-cc-pip:
    machine:
      image: ubuntu-1604:201903-01
    resource_class: large
    steps:
      - checkout
      - run:
          name: Setting Python 3 and upgrade pip
          command: |
            pyenv local 3.7.0
            pip install -U pip
      - run:
          name: Installing PyTorch
          command: |
            pip install --pre torch -f https://download.pytorch.org/whl/nightly/cu102/torch_nightly.html
            pip install numpy scipy
      - build-csprng
      - run-tests

  binary_linux_wheel:
    <<: *binary_common
    docker:
      - image: << parameters.wheel_docker_image >>
    resource_class: 2xlarge+
    steps:
      - checkout_merge
      - run: packaging/build_wheel.sh
      - store_artifacts:
          path: dist
      - persist_to_workspace:
          root: dist
          paths:
            - "*"

  binary_linux_conda:
    <<: *binary_common
    docker:
      - image: "pytorch/conda-cuda"
    resource_class: 2xlarge+
    steps:
      - checkout_merge
      - run: packaging/build_conda.sh
      - store_artifacts:
          path: /opt/conda/conda-bld/linux-64
      - persist_to_workspace:
          root: /opt/conda/conda-bld/linux-64
          paths:
            - "*"
      - store_test_results:
          path: build_results/

  unittest_linux_cpu:
    <<: *binary_common
    docker:
      - image: "pytorch/manylinux-cuda102"
    resource_class: 2xlarge+
    steps:
      - checkout
      - install-conda
      - install-pytorch
      - build-csprng
      - run-tests

  unittest_linux_gpu:
    <<: *binary_common
    machine:
      image: ubuntu-1604-cuda-10.1:201909-23
    resource_class: gpu.small
    environment:
      image_name: "pytorch/manylinux-cuda101"
    steps:
      - checkout
      - install-conda
      - install-pytorch
      - install-cuda
      - build-csprng
      - run-tests

workflows:
  build:
    jobs:
      - binary_linux_wheel:
          cu_version: cpu
          name: binary_linux_wheel_py3.6_cpu
          python_version: '3.6'
          wheel_docker_image: pytorch/manylinux-cuda102
      - binary_linux_wheel:
          cu_version: cu92
          name: binary_linux_wheel_py3.6_cu92
          python_version: '3.6'
          wheel_docker_image: pytorch/manylinux-cuda92
      - binary_linux_wheel:
          cu_version: cu101
          name: binary_linux_wheel_py3.6_cu101
          python_version: '3.6'
          wheel_docker_image: pytorch/manylinux-cuda101
      - binary_linux_wheel:
          cu_version: cu102
          name: binary_linux_wheel_py3.6_cu102
          python_version: '3.6'
          wheel_docker_image: pytorch/manylinux-cuda102
      - binary_linux_wheel:
          cu_version: cpu
          name: binary_linux_wheel_py3.7_cpu
          python_version: '3.7'
          wheel_docker_image: pytorch/manylinux-cuda102
      - binary_linux_wheel:
          cu_version: cu92
          name: binary_linux_wheel_py3.7_cu92
          python_version: '3.7'
          wheel_docker_image: pytorch/manylinux-cuda92
      - binary_linux_wheel:
          cu_version: cu101
          name: binary_linux_wheel_py3.7_cu101
          python_version: '3.7'
          wheel_docker_image: pytorch/manylinux-cuda101
      - binary_linux_wheel:
          cu_version: cu102
          name: binary_linux_wheel_py3.7_cu102
          python_version: '3.7'
          wheel_docker_image: pytorch/manylinux-cuda102
      - binary_linux_wheel:
          cu_version: cpu
          name: binary_linux_wheel_py3.8_cpu
          python_version: '3.8'
          wheel_docker_image: pytorch/manylinux-cuda102
      - binary_linux_wheel:
          cu_version: cu92
          name: binary_linux_wheel_py3.8_cu92
          python_version: '3.8'
          wheel_docker_image: pytorch/manylinux-cuda92
      - binary_linux_wheel:
          cu_version: cu101
          name: binary_linux_wheel_py3.8_cu101
          python_version: '3.8'
          wheel_docker_image: pytorch/manylinux-cuda101
      - binary_linux_wheel:
          cu_version: cu102
          name: binary_linux_wheel_py3.8_cu102
          python_version: '3.8'
          wheel_docker_image: pytorch/manylinux-cuda102

      - binary_linux_conda:
          cu_version: cpu
          name: binary_linux_conda_py3.6_cpu
          python_version: '3.6'
          wheel_docker_image: pytorch/manylinux-cuda102
      - binary_linux_conda:
          cu_version: cu92
          name: binary_linux_conda_py3.6_cu92
          python_version: '3.6'
          wheel_docker_image: pytorch/manylinux-cuda92
      - binary_linux_conda:
          cu_version: cu101
          name: binary_linux_conda_py3.6_cu101
          python_version: '3.6'
          wheel_docker_image: pytorch/manylinux-cuda101
      - binary_linux_conda:
          cu_version: cu102
          name: binary_linux_conda_py3.6_cu102
          python_version: '3.6'
          wheel_docker_image: pytorch/manylinux-cuda102
      - binary_linux_conda:
          cu_version: cpu
          name: binary_linux_conda_py3.7_cpu
          python_version: '3.7'
          wheel_docker_image: pytorch/manylinux-cuda102
      - binary_linux_conda:
          cu_version: cu92
          name: binary_linux_conda_py3.7_cu92
          python_version: '3.7'
          wheel_docker_image: pytorch/manylinux-cuda92
      - binary_linux_conda:
          cu_version: cu101
          name: binary_linux_conda_py3.7_cu101
          python_version: '3.7'
          wheel_docker_image: pytorch/manylinux-cuda101
      - binary_linux_conda:
          cu_version: cu102
          name: binary_linux_conda_py3.7_cu102
          python_version: '3.7'
          wheel_docker_image: pytorch/manylinux-cuda102
      - binary_linux_conda:
          cu_version: cpu
          name: binary_linux_conda_py3.8_cpu
          python_version: '3.8'
          wheel_docker_image: pytorch/manylinux-cuda102
      - binary_linux_conda:
          cu_version: cu92
          name: binary_linux_conda_py3.8_cu92
          python_version: '3.8'
          wheel_docker_image: pytorch/manylinux-cuda92
      - binary_linux_conda:
          cu_version: cu101
          name: binary_linux_conda_py3.8_cu101
          python_version: '3.8'
          wheel_docker_image: pytorch/manylinux-cuda101
      - binary_linux_conda:
          cu_version: cu102
          name: binary_linux_conda_py3.8_cu102
          python_version: '3.8'
          wheel_docker_image: pytorch/manylinux-cuda102

  unittest:
    jobs:
      - unittest_linux_cpu:
          cu_version: cpu
          name: unittest_linux_cpu_py3.6
          python_version: '3.6'
      - unittest_linux_cpu:
          cu_version: cpu
          name: unittest_linux_cpu_py3.7
          python_version: '3.7'
      - unittest_linux_cpu:
          cu_version: cpu
          name: unittest_linux_cpu_py3.8
          python_version: '3.8'
      - unittest_linux_gpu:
          cu_version: cu101
          filters:
            branches:
              only:
                - master
                - nightly
          name: unittest_linux_gpu_py3.6
          python_version: '3.6'
      - unittest_linux_gpu:
          cu_version: cu101
          filters:
            branches:
              only:
                - master
                - nightly
          name: unittest_linux_gpu_py3.7
          python_version: '3.7'
      - unittest_linux_gpu:
          cu_version: cu101
          name: unittest_linux_gpu_py3.8
          python_version: '3.8'
